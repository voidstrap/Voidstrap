<base:WpfUiWindow x:Class="Voidstrap.UI.Elements.ContextMenu.MusicPlayer"
                  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                  xmlns:base="clr-namespace:Voidstrap.UI.Elements.Base"
                  xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                  xmlns:models="clr-namespace:Voidstrap.UI.ViewModels.ContextMenu"
                  d:DataContext="{d:DesignInstance Type=models:MusicPlayerViewModel}"
                  mc:Ignorable="d"
                  Title="Music Player"
                  Width="1024"
                  Height="680"
                  Background="{ui:ThemeResource ApplicationBackgroundBrush}"
                  ExtendsContentIntoTitleBar="True"
                  WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                <GradientStop Offset="0.0"  Color="{DynamicResource WindowBackgroundColorPrimary}" />
                <GradientStop Offset="0.35" Color="{DynamicResource WindowBackgroundColorSecondary}" />
                <GradientStop Offset="0.75" Color="{DynamicResource WindowBackgroundColorThird}" />
                <GradientStop Offset="1.0"  Color="{DynamicResource WindowBackgroundColorPrimary}" />
            </LinearGradientBrush>
        </Grid.Background>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 🔹 Title Bar -->
        <ui:TitleBar Grid.Row="0"
                     x:Name="RootTitleBar"
                     Title="Music Player"
                     ShowMinimize="True"
                     ShowMaximize="True"
                     Icon="pack://application:,,,/Voidstrap.ico"
                     Background="{DynamicResource WindowTitleBarBackgroundBrush}" />

        <!-- 🔹 Tabs -->
        <TabControl Grid.Row="1" Margin="12" Background="Transparent">

            <!-- 🎵 Music Browser Tab -->
            <TabItem Header="Music Browser">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 🔍 Search Bar -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <TextBox Width="240"
                     Height="32"
                     VerticalContentAlignment="Center"
                     Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <!-- 🎶 Music Library -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding FilteredMusicLibrary}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="{x:Type models:TrackItem}">
                                    <Border CornerRadius="8"
                                Padding="8"
                                Margin="6"
                                Background="{DynamicResource ControlFillColorDefaultBrush}">
                                        <DockPanel>
                                            <!-- Album icon / artwork -->
                                            <Image Source="{Binding Icon}"
                                       Width="64" Height="64"
                                       Margin="0,0,8,0"
                                       Stretch="UniformToFill"
                                       ClipToBounds="True" />

                                            <!-- Track details -->
                                            <StackPanel DockPanel.Dock="Left" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Title}"
                                               FontWeight="SemiBold"
                                               FontSize="14"/>
                                                <TextBlock Text="{Binding Artist}"
                                               FontSize="12"
                                               Opacity="0.7"/>
                                            </StackPanel>

                                            <!-- Download button -->
                                            <ui:Button Content="Download"
                                           Icon="ArrowDownload24"
                                           Appearance="Primary"
                                           DockPanel.Dock="Right"
                                           Command="{Binding DataContext.DownloadCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                           CommandParameter="{Binding}"
                                           HorizontalAlignment="Right"/>
                                        </DockPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </TabItem>



            <!-- 🎧 Music Player Tab -->
            <TabItem Header="Music Player">
                <Grid Margin="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="360"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Track List -->
                    <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="Library" FontSize="18" FontWeight="Medium" Margin="0,0,0,8"/>

                            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                <ui:Button Content="Import Files"
                                           Command="{Binding OpenFilesCommand}"
                                           Appearance="Secondary"/>

                                <ui:Button Content="Connect RPC"
                                           Command="{Binding ConnectRpcCommand}"
                                           Appearance="Secondary"
                                           Margin="4,0,0,0"/>
                            </StackPanel>

                            <ListView ItemsSource="{Binding Tracks}"
                                      SelectedItem="{Binding SelectedTrack, Mode=TwoWay}"
                                      BorderThickness="0">
                                <ListView.ItemTemplate>
                                    <DataTemplate DataType="{x:Type models:TrackItem}">
                                        <Border Margin="0,2" CornerRadius="4" Padding="4"
                                                Background="{DynamicResource ControlFillColorDefaultBrush}">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="44"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <Image Source="{Binding Icon}" Width="36" Height="36"
                                                       Margin="4" Grid.Column="0"
                                                       Stretch="UniformToFill" ClipToBounds="True" />

                                                <StackPanel Grid.Column="1" Orientation="Vertical" Margin="6,0,0,0">
                                                    <TextBox Text="{Binding Title, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
         FontWeight="SemiBold"
         FontSize="14"
         BorderThickness="0"
         Background="Transparent"
         Padding="2"
         KeyDown="TrackTitleEdit_KeyDown"
         ToolTip="{Binding Title}"
         MaxLength="30"
         TextWrapping="NoWrap"/>

                                                    <TextBlock Text="{Binding FileType}" Opacity="0.7" FontSize="12"/>
                                                </StackPanel>

                                                <StackPanel Grid.Column="2" Orientation="Horizontal"
                                                            HorizontalAlignment="Right" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding DurationString}" Opacity="0.8" Margin="0,0,8,0"/>
                                                    <ui:Button Icon="Delete24"
                                                               ToolTip="Remove Track"
                                                               Appearance="Danger"
                                                               Width="28" Height="28"
                                                               Command="{Binding DataContext.RemoveTrackCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                               CommandParameter="{Binding}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </StackPanel>
                    </ScrollViewer>

                    <Grid Grid.Column="1"/>

                    <!-- Right: Player Controls -->
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Now Playing" FontSize="18" FontWeight="Medium"/>

                        <Border CornerRadius="4"
                                Padding="16"
                                Margin="0,8,0,16"
                                BorderThickness="1"
                                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                Background="{DynamicResource ControlFillColorDefaultBrush}">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                    <Image Source="{Binding NowPlaying.Icon}" Width="64" Height="64" Margin="0,0,12,0"
                                           Stretch="UniformToFill" ClipToBounds="True" />
                                    <StackPanel>
                                        <TextBlock Text="{Binding NowPlaying.Title}" FontSize="18" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding NowPlaying.FileType}" Opacity="0.7"/>
                                        <TextBlock Text="{Binding NowPlaying.FilePath}" FontSize="11" Opacity="0.6" TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                </StackPanel>

                                <Slider Minimum="0"
                                        Maximum="{Binding NowPlayingDurationSeconds}"
                                        Value="{Binding PositionSeconds, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Margin="0,4,0,0"/>

                                <DockPanel Margin="0,4,0,0">
                                    <TextBlock DockPanel.Dock="Left" Text="{Binding PositionString}" />
                                    <TextBlock Text="   |   " />
                                    <TextBlock DockPanel.Dock="Right" Text="{Binding DurationString}" />
                                </DockPanel>
                            </StackPanel>
                        </Border>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,0,0,12">
                            <ui:Button Icon="ArrowLeft24" Content="Previous" Command="{Binding PreviousCommand}" Width="100"/>
                            <ui:Button Icon="MusicNote224" Margin="4,0,0,0"
                                       Content="{Binding PlayPauseLabel}"
                                       Command="{Binding PlayPauseCommand}"
                                       Appearance="Primary"
                                       Width="120"/>
                            <ui:Button Icon="ArrowRight24" Margin="4,0,0,0" Content="Next" Command="{Binding NextCommand}" Width="80"/>
                            <ui:Button Icon="Stop24" Margin="4,0,0,0" Content="Stop" Command="{Binding StopCommand}" Width="80"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                            <TextBlock Text="Volume" Margin="0,0,6,0" VerticalAlignment="Center"/>
                            <Slider Width="200"
                                    Minimum="0"
                                    Maximum="1.0"
                                    Value="{Binding Volume, Mode=TwoWay}"
                                    TickFrequency="0.1"/>
                            <ui:Button Icon="ArrowRepeatAll24"
                                       Content="{Binding LoopLabel}"
                                       Command="{Binding ToggleLoopCommand}"
                                       Width="80"
                                       Margin="8,-4,0,0" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- 🔹 Footer -->
        <DockPanel Grid.Row="2" Margin="12,0,12,12">
            <TextBlock Text="{Binding Status}" />
            <TextBlock DockPanel.Dock="Right" Text="{Binding Tracks.Count, StringFormat=Tracks: {0}}"/>
        </DockPanel>
    </Grid>
</base:WpfUiWindow>
